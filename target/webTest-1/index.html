<!DOCTYPE html>
<html>
    <head>
        <title>Start Page</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <style>
            footer{
                position: fixed;
                left: 0;
                bottom: 0;
                width: 100%;
                color: white;
                text-align: center;
            }
        </style>
    </head>

    <body>

        <footer >

            <button id="read">Connect with BLE device</button>
            <button id="start" disabled>Start</button>
            <button id="stop" disabled>Stop</button>
            <pre id="test"></pre>
        </footer>
    </body>

    <script>
        var deviceName = 'Palm'
        var bleService = 'environmental_sensing'
        var bleCharacteristic = 'uv_index'
        var bluetoothDeviceDetected
        var gattCharacteristic
        
        chrome.bluetooth.getAdapterState(function (adapter) {
            alert("Adapter " + adapter.address + ": " + adapter.name);
//            console.log("Adapter " + adapter.address + ": " + adapter.name);
        });

//        document.querySelector('#read').addEventListener('click', function () {
//            if (isWebBluetoothEnabled()) {
//                read()
//            }
//        })
//
//        document.querySelector('#start').addEventListener('click', function (event) {
//            if (isWebBluetoothEnabled()) {
//                start()
//            }
//        })
//
//        document.querySelector('#stop').addEventListener('click', function (event) {
//            if (isWebBluetoothEnabled()) {
//                stop()
//            }
//        })
//
//        function isWebBluetoothEnabled() {
//            if (!navigator.bluetooth) {
//                console.log('Web Bluetooth API is not available in this browser!')
//                return false
//            }
//
//            return true
//        }
//
//        function getDeviceInfo() {
//            let options = {
//                acceptAllDevices: true
//            }
//
//            console.log('Requesting any Bluetooth Device...')
//            return navigator.bluetooth.requestDevice(options).then(device => {
//                bluetoothDeviceDetected = device
//            }).catch(error => {
//                console.log('Argh! ' + error)
//            })
//        }
//
//        function read() {
//            return (bluetoothDeviceDetected ? Promise.resolve() : getDeviceInfo())
//                    .then(connectGATT)
//                    .then(_ => {
//                        console.log('Reading UV Index...')
//                        return gattCharacteristic.readValue()
//                    })
//                    .catch(error => {
//                        console.log('Waiting to start reading: ' + error)
//                    })
//        }
//
//        function connectGATT() {
//            if (bluetoothDeviceDetected.gatt.connected && gattCharacteristic) {
//                return Promise.resolve()
//            }
//
//            return bluetoothDeviceDetected.gatt.connect()
//                    .then(server => {
//                        console.log('Getting GATT Service...')
//                        return server.getPrimaryService()
//                    })
//                    .then(service => {
//                        console.log('Getting GATT Characteristic...')
//                        return service.getCharacteristic(bleCharacteristic)
//                    })
//                    .then(characteristic => {
//                        gattCharacteristic = characteristic
//                        gattCharacteristic.addEventListener('characteristicvaluechanged',
//                                handleChangedValue)
//                        document.querySelector('#start').disabled = false
//                        document.querySelector('#stop').disabled = true
//                    })
//        }
//
//        function handleChangedValue(event) {
//            let value = event.target.value.getUint8(0)
//            var now = new Date()
//            console.log('> ' + now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + ' UV Index is ' + value)
//        }
//
//        function start() {
//            gattCharacteristic.startNotifications()
//                    .then(_ => {
//                        console.log('Start reading...')
//                        document.querySelector('#start').disabled = true
//                        document.querySelector('#stop').disabled = false
//                    })
//                    .catch(error => {
//                        console.log('[ERROR] Start: ' + error)
//                    })
//        }
//
//        function stop() {
//            gattCharacteristic.stopNotifications()
//                    .then(_ => {
//                        console.log('Stop reading...')
//                        document.querySelector('#start').disabled = false
//                        document.querySelector('#stop').disabled = true
//                    })
//                    .catch(error => {
//                        console.log('[ERROR] Stop: ' + error)
//                    })
//        }
    </script>

</html>
